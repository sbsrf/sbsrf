name: Release (Manual Trigger)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: '测试原因（选填）'
        required: false
        default: 'Manual test run'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download and extract librime binary
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path librime -Force
          Invoke-WebRequest -Uri "https://github.com/rime/librime/releases/download/1.16.1/rime-de4700e-Windows-msvc-x64.7z" -OutFile "librime/rime.7z" -UseBasicParsing
          7z x "librime/rime.7z" -o"librime" -y

          # 关键修正：根据实际目录结构，将 bin 和 lib 目录都添加到 PATH
          # 这样系统既能找到 rime_deployer.exe，也能找到它依赖的 rime.dll
          $librimeBinPath = Join-Path -Path $pwd -ChildPath "librime\dist\bin"
          $librimeLibPath = Join-Path -Path $pwd -ChildPath "librime\dist\lib"
          echo "PATH=$librimeBinPath;$librimeLibPath;$env:PATH" >> $env:GITHUB_ENV

      - name: Build
        id: build
        shell: pwsh
        run: |
          # 现在可以直接使用 rime_deployer 命令，因为 PATH 已正确配置
          Move-Item -Path sbxlm\* -Destination . -Force
          rime_deployer --build . "C:\Program Files\Rime\data"
          
          Remove-Item -Path bihua*, zhlf*, sbfc*, *.extended.dict.yaml, *2.schema.yaml, user.yaml, sbpy.base.dict.yaml, sbpy.ext.dict.yaml, sbpy.tencent.dict.yaml -Force
          Compress-Archive -Path build, lua, opencc, *.yaml, *.txt -DestinationPath sbsrf.zip -Force

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: sbsrf.zip
          prerelease: true
          body: |
            **Trigger Type**: Manual
            **Reason**: ${{ github.event.inputs.reason }}

      - name: notice
        uses: fjogeleit/http-request-action@v1
        with:
          url: 'https://5b042a5455e0480fa806fc9483f9a8a1-cn-chengdu.alicloudapi.com/external/v1/releases/notifications?key=sbsrf'
          method: 'GET'
