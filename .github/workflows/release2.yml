name: Release (Manual Trigger)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: '测试原因（选填）'
        required: false
        default: 'Manual test run'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download and extract librime binary
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path librime -Force
          Invoke-WebRequest -Uri "https://github.com/rime/librime/releases/download/1.16.1/rime-de4700e-Windows-msvc-x64.7z" -OutFile "librime/rime.7z" -UseBasicParsing
          7z x "librime/rime.7z" -o"librime" -y
          # 不再尝试修改系统 PATH，而是在后续步骤中使用绝对路径

      - name: Build
        id: build
        shell: pwsh
        run: |
          # 1. 定义 rime_deployer.exe 的绝对路径
          $deployerPath = Join-Path -Path $pwd -ChildPath "librime\dist\bin\rime_deployer.exe"
          
          # 2. 检查文件是否存在，确保路径正确
          if (-Not (Test-Path $deployerPath)) {
              Write-Error "rime_deployer.exe not found at path: $deployerPath"
              # 列出目录内容以便调试
              Get-ChildItem -Path "librime\bin"
              exit 1
          }

          # 3. 使用绝对路径执行构建命令
          Move-Item -Path sbxlm\* -Destination . -Force
          & $deployerPath --build . "C:\Program Files\Rime\data"
          
          # 后续步骤保持不变
          Remove-Item -Path bihua*, zhlf*, sbfc*, *.extended.dict.yaml, *2.schema.yaml, sbpy.base.dict.yaml, sbpy.ext.dict.yaml, sbpy.tencent.dict.yaml -Force
          Compress-Archive -Path build, lua, opencc, *.yaml, *.txt -DestinationPath sbsrf.zip -Force

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: sbsrf.zip
          prerelease: true
          body: |
            **Trigger Type**: Manual
            **Reason**: ${{ github.event.inputs.reason }}

      - name: notice
        uses: fjogeleit/http-request-action@v1
        with:
          url: 'https://5b042a5455e0480fa806fc9483f9a8a1-cn-chengdu.alicloudapi.com/external/v1/releases/notifications?key=sbsrf'
          method: 'GET'
