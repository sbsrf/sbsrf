name: Release (Manual Trigger)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: '测试原因（选填）'
        required: false
        default: 'Manual test run'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download and extract librime binary
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path librime -Force
          Invoke-WebRequest -Uri "https://github.com/rime/librime/releases/download/1.16.1/rime-de4700e-Windows-msvc-x64.7z" -OutFile "librime/rime.7z" -UseBasicParsing
          7z x "librime/rime.7z" -o"librime" -y
          
          # 调试：列出解压后的 librime 目录结构
          Write-Host "=== 解压后的 librime 目录结构 ==="
          Get-ChildItem -Path "librime" -Recurse | Format-Table -Property FullName
          
          $librimeBinPath = Join-Path -Path $pwd -ChildPath "librime\dist\bin"
          $librimeLibPath = Join-Path -Path $pwd -ChildPath "librime\dist\lib"
          echo "PATH=$librimeBinPath;$librimeLibPath;$env:PATH" >> $env:GITHUB_ENV

      - name: Build
        id: build
        shell: pwsh
        run: |
          # 调试：列出当前目录在构建前的文件
          Write-Host "=== 构建前的当前目录文件 ==="
          Get-ChildItem -Path .
          
          Move-Item -Path sbxlm\* -Destination . -Force
          
          # 调试：列出移动文件后的当前目录文件
          Write-Host "=== 移动文件后的当前目录文件 ==="
          Get-ChildItem -Path .
          
          # 执行构建
          rime_deployer --build . "C:\Program Files\Rime\data"
          
          # 调试：列出构建后的当前目录文件
          Write-Host "=== 构建后的当前目录文件 ==="
          Get-ChildItem -Path .
          
          # 删除文件
          Remove-Item -Path bihua*, zhlf*, sbfc*, *.extended.dict.yaml, *2.schema.yaml, user.yaml, sbpy.base.dict.yaml, sbpy.ext.dict.yaml, sbpy.tencent.dict.yaml -Force -ErrorAction SilentlyContinue
          
          # 调试：列出删除文件后的当前目录文件
          Write-Host "=== 删除文件后的当前目录文件 ==="
          Get-ChildItem -Path .
          
          Compress-Archive -Path build, lua, opencc, *.yaml, *.txt -DestinationPath sbsrf.zip -Force

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: sbsrf.zip
          prerelease: true
          body: |
            **Trigger Type**: Manual
            **Reason**: ${{ github.event.inputs.reason }}
