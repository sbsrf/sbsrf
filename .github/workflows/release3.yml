name: Release (macOS)

# æ”¯æŒæ‰‹åŠ¨è§¦å‘ + æ ‡ç­¾æ¨é€è§¦å‘ï¼ˆå¯é€‰ï¼‰
on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'æµ‹è¯•åŸå› ï¼ˆé€‰å¡«ï¼‰'
        required: false
        default: 'Manual test run on macOS'
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build-on-macos:
    runs-on: macos-latest
    defaults:
      run:
        shell: zsh {0} # å…¨å±€ä½¿ç”¨ zsh æ‰§è¡Œå‘½ä»¤

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and extract librime
        run: |
          # å®šä¹‰å˜é‡ï¼ˆå¯¹åº”æœ¬åœ°è„šæœ¬çš„é…ç½®éƒ¨åˆ†ï¼‰
          LIBRIME_URL="https://github.com/rime/librime/releases/download/1.16.1/rime-de4700e-macOS-universal.tar.bz2"
          LIBRIME_ARCHIVE="librime/rime.tar.bz2"
          
          # åˆ›å»ºç›®å½•å¹¶ä¸‹è½½æ–‡ä»¶
          mkdir -p librime
          curl -L -o "$LIBRIME_ARCHIVE" "$LIBRIME_URL" || { echo "âŒ ä¸‹è½½ librime å¤±è´¥"; exit 1; }
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [[ ! -f "$LIBRIME_ARCHIVE" ]]; then
              echo "âŒ ä¸‹è½½çš„ librime æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
          fi
          
          # è§£å‹æ–‡ä»¶ï¼ˆé€‚é… macOS ç¯å¢ƒï¼‰
          tar -xjf "$LIBRIME_ARCHIVE" -C librime/ --strip-components=2 || { echo "âŒ è§£å‹ librime å¤±è´¥"; exit 1; }
          echo "âœ… å·²è§£å‹ librime åˆ°: $PWD/librime"

      - name: Configure environment variables
        run: |
          # é…ç½®å¯æ‰§è¡Œæ–‡ä»¶å’ŒåŠ¨æ€åº“è·¯å¾„
          LIBRIME_PATH="$PWD/librime"
          echo "PATH=$LIBRIME_PATH:$PATH" >> $GITHUB_ENV
          echo "DYLD_LIBRARY_PATH=$LIBRIME_PATH:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV
          
          # éªŒè¯ç¯å¢ƒå˜é‡é…ç½®
          echo "âœ… å·²é…ç½®ç¯å¢ƒå˜é‡ï¼š"
          echo "  - PATH: $LIBRIME_PATH"
          echo "  - DYLD_LIBRARY_PATH: $LIBRIME_PATH"

      - name: Verify rime_deployer and dependencies
        run: |
          # éªŒè¯ rime_deployer æ˜¯å¦å¯ç”¨
          if command -v rime_deployer &> /dev/null; then
              echo "âœ… rime_deployer å‘½ä»¤å¯ç”¨"
              # æ£€æŸ¥åŠ¨æ€åº“ä¾èµ–
              if otool -L $(command -v rime_deployer) | grep -q librime; then
                  echo "âœ… librime åŠ¨æ€åº“ä¾èµ–æ­£å¸¸"
              else
                  echo "âŒ rime_deployer å­˜åœ¨ä½†æœªæ‰¾åˆ° librime åŠ¨æ€åº“"
                  exit 1
              fi
          else
              echo "âŒ æ— æ³•æ‰¾åˆ° rime_deployer å‘½ä»¤"
              # è°ƒè¯•ï¼šåˆ—å‡º librime ç›®å½•ç»“æ„
              echo "ğŸ“‹ librime ç›®å½•ç»“æ„ï¼š"
              ls -la $LIBRIME_PATH
              exit 1
          fi

      - name: Build project
        run: |
          # åˆ—å‡ºå½“å‰ç›®å½•æ–‡ä»¶ï¼ˆè°ƒè¯•ç”¨ï¼‰
          echo "ğŸ“‹ æ„å»ºå‰å½“å‰ç›®å½•æ–‡ä»¶ï¼š"
          ls -la
          
          # ç§»åŠ¨ sbxlm ç›®å½•æ–‡ä»¶
          echo "ğŸ”„ ç§»åŠ¨ sbxlm ç›®å½•ä¸‹çš„æ–‡ä»¶..."
          mv -f sbxlm/* . 2>/dev/null || echo "âš ï¸ sbxlm ç›®å½•å¯èƒ½ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œè·³è¿‡ç§»åŠ¨"
          
          # æ‰§è¡Œæ„å»ºå‘½ä»¤ï¼ˆé€‚é… GitHub Actions çš„ macOS ç¯å¢ƒï¼‰
          echo "ğŸ”¨ è¿è¡Œ rime_deployer --build..."
          rime_deployer --build . "$HOME/Library/Rime" || { echo "âŒ æ„å»ºå¤±è´¥"; exit 1; }

      - name: Clean up unnecessary files
        run: |
          # æ¸…ç†æ–‡ä»¶
          rm -rf bihua* zhlf* sbfc* *.extended.dict.yaml *2.schema.yaml user.yaml sbpy.base.dict.yaml sbpy.ext.dict.yaml sbpy.tencent.dict.yaml 2>/dev/null
          echo "âœ… æ–‡ä»¶æ¸…ç†å®Œæˆ"

      - name: Package build artifacts
        run: |
          # æ‰“åŒ…ç”Ÿæˆå‹ç¼©åŒ…
          zip -q -r sbsrf.zip build lua opencc *.yaml *.txt 2>/dev/null
          
          # æ£€æŸ¥æ‰“åŒ…ç»“æœ
          if [[ -f "sbsrf.zip" ]]; then
              echo "âœ… æ‰“åŒ…æˆåŠŸï¼æ–‡ä»¶ä½ç½®ï¼š$PWD/sbsrf.zip"
              # è¾“å‡ºæ–‡ä»¶å¤§å°ï¼ˆè°ƒè¯•ç”¨ï¼‰
              du -h sbsrf.zip
          else
              echo "âš ï¸  æ‰“åŒ…æ­¥éª¤æœªæ‰¾åˆ°æŒ‡å®šæ–‡ä»¶ï¼Œæœªç”Ÿæˆ sbsrf.zip"
          fi

      - name: Upload release artifact
        uses: softprops/action-gh-release@v1
        with:
          files: sbsrf.zip
          # æ‰‹åŠ¨è§¦å‘æ ‡è®°ä¸ºé¢„å‘å¸ƒï¼Œæ ‡ç­¾æ¨é€è§¦å‘ä¸ºæ­£å¼å‘å¸ƒ
          prerelease: ${{ github.event_name == 'workflow_dispatch' }}
          body: |
            **Build Environment**: macOS-latest
            **Trigger Type**: ${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'Tag Push' }}
            ${{ github.event_name == 'workflow_dispatch' && '**Reason**: ' + github.event.inputs.reason || '' }}

      - name: Send notification (optional)
        run: |
          # å¯é€‰ï¼šä¿ç•™åŸè„šæœ¬çš„é€šçŸ¥é€»è¾‘ï¼ˆå¦‚æœéœ€è¦ï¼‰
          curl -X GET "https://5b042a5455e0480fa806fc9483f9a8a1-cn-chengdu.alicloudapi.com/external/v1/releases/notifications?key=sbsrf"
        continue-on-error: true # é€šçŸ¥å¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹