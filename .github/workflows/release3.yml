name: Release (macOS)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'æµ‹è¯•åŸå› ï¼ˆé€‰å¡«ï¼‰'
        required: false
        default: 'Manual test run on macOS'
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build-on-macos:
    runs-on: macos-latest
    defaults:
      run:
        shell: zsh {0}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and extract librime
        run: |
          LIBRIME_URL="https://github.com/rime/librime/releases/download/1.16.1/rime-de4700e-macOS-universal.tar.bz2"
          LIBRIME_ARCHIVE="librime/rime.tar.bz2"
          
          mkdir -p librime
          curl -L -o "$LIBRIME_ARCHIVE" "$LIBRIME_URL" || { echo "âŒ ä¸‹è½½ librime å¤±è´¥"; exit 1; }
          
          if [[ ! -f "$LIBRIME_ARCHIVE" ]]; then
              echo "âŒ ä¸‹è½½çš„ librime æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
          fi
          
          tar -xjf "$LIBRIME_ARCHIVE" -C librime/ --strip-components=2 || { echo "âŒ è§£å‹ librime å¤±è´¥"; exit 1; }
          echo "âœ… å·²è§£å‹ librime åˆ°: $PWD/librime"
          # æ‰“å° librime ç›®å½•æ–‡ä»¶ï¼Œç¡®è®¤åŠ¨æ€åº“å­˜åœ¨
          echo "ğŸ“‹ librime ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la $PWD/librime
          # ç¡®è®¤ librime.1.dylib å­˜åœ¨
          if [[ ! -f "$PWD/librime/librime.1.dylib" ]]; then
              echo "âŒ æœªæ‰¾åˆ° librime.1.dylib åŠ¨æ€åº“"
              exit 1
          fi

      - name: Fix rime_deployer dynamic library path (æ ¸å¿ƒä¿®å¤)
        run: |
          LIBRIME_PATH="$PWD/librime"
          RIME_DEPLOYER_PATH="$LIBRIME_PATH/rime_deployer"
          LIBRIME_DYLIB_PATH="$LIBRIME_PATH/librime.1.dylib"
          
          # 1. æŸ¥çœ‹åŸå§‹çš„åŠ¨æ€åº“å¼•ç”¨è·¯å¾„
          echo "ğŸ“‹ åŸå§‹åŠ¨æ€åº“å¼•ç”¨è·¯å¾„ï¼š"
          otool -L "$RIME_DEPLOYER_PATH" | grep librime
          
          # 2. ä¿®å¤ rpath é…ç½®ï¼ˆå…³é”®ï¼šå°† @rpath æ”¹ä¸ºç»å¯¹è·¯å¾„ï¼‰
          echo "ğŸ”§ ä¿®å¤åŠ¨æ€åº“å¼•ç”¨è·¯å¾„..."
          install_name_tool -change "@rpath/librime.1.dylib" "$LIBRIME_DYLIB_PATH" "$RIME_DEPLOYER_PATH"
          
          # 3. éªŒè¯ä¿®å¤ç»“æœ
          echo "ğŸ“‹ ä¿®å¤ååŠ¨æ€åº“å¼•ç”¨è·¯å¾„ï¼š"
          otool -L "$RIME_DEPLOYER_PATH" | grep librime
          
          # 4. æµ‹è¯•åŠ¨æ€åº“åŠ è½½ï¼ˆæ­¤æ—¶æ— éœ€ DYLD_LIBRARY_PATH ä¹Ÿèƒ½åŠ è½½ï¼‰
          echo "ğŸ” æµ‹è¯•åŠ¨æ€åº“åŠ è½½..."
          if "$RIME_DEPLOYER_PATH" -h >/dev/null 2>&1; then
              echo "âœ… åŠ¨æ€åº“åŠ è½½æµ‹è¯•é€šè¿‡"
          else
              echo "âŒ åŠ¨æ€åº“åŠ è½½æµ‹è¯•ä»å¤±è´¥"
              exit 1
          fi

      - name: Configure environment variables
        run: |
          LIBRIME_PATH="$PWD/librime"
          # å†™å…¥ GITHUB_ENV ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "LIBRIME_PATH=$LIBRIME_PATH" >> $GITHUB_ENV
          # é…ç½® PATH
          export PATH="$LIBRIME_PATH:$PATH"
          echo "âœ… å·²é…ç½®ç¯å¢ƒå˜é‡ï¼š"
          echo "  - LIBRIME_PATH: $LIBRIME_PATH"
          echo "  - PATH: $PATH"

      - name: Verify rime_deployer and dependencies
        run: |
          export LIBRIME_PATH="${{ env.LIBRIME_PATH }}"
          export PATH="$LIBRIME_PATH:$PATH"
          
          if command -v rime_deployer &> /dev/null; then
              echo "âœ… rime_deployer å‘½ä»¤å¯ç”¨"
              echo "ğŸ“‹ rime_deployer è·¯å¾„ï¼š$(which rime_deployer)"
              # å†æ¬¡éªŒè¯åŠ¨æ€åº“ä¾èµ–
              otool -L $(which rime_deployer) | grep -q librime && echo "âœ… librime åŠ¨æ€åº“ä¾èµ–æ­£å¸¸" || {
                  echo "âŒ rime_deployer å­˜åœ¨ä½†æœªæ‰¾åˆ° librime åŠ¨æ€åº“"
                  ls -la $LIBRIME_PATH
                  exit 1
              }
          else
              echo "âŒ æ— æ³•æ‰¾åˆ° rime_deployer å‘½ä»¤"
              ls -la $LIBRIME_PATH
              exit 1
          fi

      - name: Build project
        run: |
          export LIBRIME_PATH="${{ env.LIBRIME_PATH }}"
          export PATH="$LIBRIME_PATH:$PATH"
          
          # å®Œæ•´è°ƒè¯•æ—¥å¿—
          echo "ğŸ“‹ è°ƒè¯•ï¼šå½“å‰å·¥ä½œç›®å½•"
          pwd
          echo "ğŸ“‹ è°ƒè¯•ï¼šå½“å‰ç›®å½•å®Œæ•´æ–‡ä»¶åˆ—è¡¨"
          ls -la
          echo "ğŸ“‹ è°ƒè¯•ï¼šsbxlm ç›®å½•å†…å®¹"
          ls -la sbxlm/ 2>/dev/null || echo "sbxlm ç›®å½•ä¸å­˜åœ¨/ä¸ºç©º"
          
          echo "ğŸ”„ ç§»åŠ¨ sbxlm ç›®å½•ä¸‹çš„æ–‡ä»¶..."
          setopt null_glob
          mv -f sbxlm/* . 2>/dev/null || echo "âš ï¸ sbxlm ç›®å½•å¯èƒ½ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          unsetopt null_glob
          echo "ğŸ“‹ è°ƒè¯•ï¼šç§»åŠ¨æ–‡ä»¶åçš„ç›®å½•å†…å®¹"
          ls -la
          
          echo "ğŸ“‹ è°ƒè¯•ï¼šrime_deployer è¯¦ç»†ä¿¡æ¯"
          which rime_deployer
          file $(which rime_deployer)
          otool -L $(which rime_deployer)
          
          # æ”¹ç”¨ä¸´æ—¶ç›®å½•æ„å»º
          RIME_TEMP_DIR="$PWD/tmp_rime"
          mkdir -p "$RIME_TEMP_DIR"
          echo "ğŸ“‹ è°ƒè¯•ï¼šç›®æ ‡ç›®å½•ï¼š$RIME_TEMP_DIR"
          
          echo "ğŸ”¨ è¿è¡Œ rime_deployer --build..."
          set -x
          # ä¿®å¤åæ— éœ€å¼ºåˆ¶æŒ‡å®š DYLD_LIBRARY_PATH
          rime_deployer --build -v . "$RIME_TEMP_DIR" 2>&1 | tee build_error.log
          BUILD_EXIT_CODE=$?
          set +x
          
          if [[ $BUILD_EXIT_CODE -ne 0 ]]; then
              echo "âŒ æ„å»ºå¤±è´¥ï¼è¯¦ç»†æ—¥å¿—ï¼š"
              cat build_error.log
              exit 1
          fi
          echo "âœ… æ„å»ºæˆåŠŸï¼"

      - name: Clean up unnecessary files
        run: |
          rm -rf bihua* zhlf* sbfc* *.extended.dict.yaml *2.schema.yaml user.yaml sbpy.base.dict.yaml sbpy.ext.dict.yaml sbpy.tencent.dict.yaml 2>/dev/null
          echo "âœ… æ–‡ä»¶æ¸…ç†å®Œæˆ"

      - name: Package build artifacts
        run: |
          zip -q -r sbsrf.zip build lua opencc *.yaml *.txt 2>/dev/null
          if [[ -f "sbsrf.zip" ]]; then
              echo "âœ… æ‰“åŒ…æˆåŠŸï¼æ–‡ä»¶ä½ç½®ï¼š$PWD/sbsrf.zip"
              du -h sbsrf.zip
          else
              echo "âš ï¸  æ‰“åŒ…æ­¥éª¤æœªæ‰¾åˆ°æŒ‡å®šæ–‡ä»¶ï¼Œæœªç”Ÿæˆ sbsrf.zip"
          fi

      - name: Upload release artifact
        uses: softprops/action-gh-release@v1
        with:
          files: sbsrf.zip
          prerelease: ${{ github.event_name == 'workflow_dispatch' }}
          body: |
            **Build Environment**: macOS-latest
            **Trigger Type**: ${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'Tag Push' }}
            ${{ github.event_name == 'workflow_dispatch' && format('**Reason**: {0}', github.event.inputs.reason) || '' }}
