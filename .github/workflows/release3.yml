name: Release (macOS)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'æµ‹è¯•åŸå› ï¼ˆé€‰å¡«ï¼‰'
        required: false
        default: 'Manual test run on macOS'
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build-on-macos:
    runs-on: macos-latest
    defaults:
      run:
        shell: zsh {0}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install missing dependencies
        run: |
          # è‡ªåŠ¨é€‚é… Apple Silicon/Intel æ¶æ„
          if [[ $(uname -m) == "arm64" ]]; then
              HOMEBREW_PATH="/opt/homebrew"
          else
              HOMEBREW_PATH="/usr/local"
          fi
          echo "HOMEBREW_PATH=$HOMEBREW_PATH" >> $GITHUB_ENV
          LIBRIME_PATH="$PWD/librime"
          echo "LIBRIME_PATH=$LIBRIME_PATH" >> $GITHUB_ENV

          # å®‰è£… Homebrew åŠ boost ä¾èµ–
          if [[ ! -f "$HOMEBREW_PATH/bin/brew" ]]; then
              /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          "$HOMEBREW_PATH/bin/brew" install boost

      - name: Download and extract librime
        run: |
          LIBRIME_URL="https://github.com/rime/librime/releases/download/1.16.1/rime-de4700e-macOS-universal.tar.bz2"
          LIBRIME_ARCHIVE="librime/rime.tar.bz2"
          
          mkdir -p "${{ env.LIBRIME_PATH }}"
          curl -L -o "$LIBRIME_ARCHIVE" "$LIBRIME_URL" || { echo "âŒ ä¸‹è½½ librime å¤±è´¥"; exit 1; }
          tar -xjf "$LIBRIME_ARCHIVE" -C "${{ env.LIBRIME_PATH }}/" --strip-components=2 || { echo "âŒ è§£å‹ librime å¤±è´¥"; exit 1; }
          
          # éªŒè¯æ ¸å¿ƒæ–‡ä»¶å­˜åœ¨
          if [[ ! -f "${{ env.LIBRIME_PATH }}/librime.1.dylib" || ! -f "${{ env.LIBRIME_PATH }}/rime_deployer" ]]; then
              echo "âŒ librime æ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±"
              ls -la "${{ env.LIBRIME_PATH }}"
              exit 1
          fi
          echo "âœ… librime è§£å‹æˆåŠŸ"

      - name: Fix dynamic library paths
        run: |
          HOMEBREW_PATH="${{ env.HOMEBREW_PATH }}"
          LIBRIME_PATH="${{ env.LIBRIME_PATH }}"
          RIME_DEPLOYER="$LIBRIME_PATH/rime_deployer"
          LIBRIME_DYLIB="$LIBRIME_PATH/librime.1.dylib"

          # ä¿®å¤ rime_deployer å¯¹ librime çš„å¼•ç”¨
          install_name_tool -change "@rpath/librime.1.dylib" "$LIBRIME_DYLIB" "$RIME_DEPLOYER"
          
          # ä¿®å¤ librime ä¾èµ–çš„ç³»ç»Ÿåº“
          SYSTEM_ICONV="/usr/lib/libiconv.2.dylib"
          if otool -L "$LIBRIME_DYLIB" | grep -q "@rpath/libiconv"; then
              install_name_tool -change "@rpath/libiconv.2.dylib" "$SYSTEM_ICONV" "$LIBRIME_DYLIB"
          fi
          
          # ä¿®å¤ boost ä¾èµ–
          BOOST_LIB="$HOMEBREW_PATH/lib/libboost_regex-mt.dylib"
          if otool -L "$LIBRIME_DYLIB" | grep -q "@rpath/libboost"; then
              install_name_tool -change "@rpath/libboost_regex-mt.dylib" "$BOOST_LIB" "$LIBRIME_DYLIB"
          fi
          echo "âœ… åŠ¨æ€åº“è·¯å¾„ä¿®å¤å®Œæˆ"

      - name: Verify dynamic library loading (ä¿®æ­£æµ‹è¯•é€»è¾‘)
        run: |
          HOMEBREW_PATH="${{ env.HOMEBREW_PATH }}"
          LIBRIME_PATH="${{ env.LIBRIME_PATH }}"
          
          # é…ç½®åŠ¨æ€åº“è·¯å¾„
          export DYLD_LIBRARY_PATH="$LIBRIME_PATH:$HOMEBREW_PATH/lib:/usr/lib"
          export PATH="$LIBRIME_PATH:$PATH"

          # æ­£ç¡®çš„æµ‹è¯•æ–¹å¼ï¼šæ‰§è¡Œ rime_deployer æ— å‚æ•°ï¼ˆä¸æŠ¥é”™=åŠ è½½æˆåŠŸï¼‰
          echo "ğŸ“‹ æµ‹è¯•åŠ¨æ€åº“åŠ è½½ï¼ˆæ‰§è¡Œ rime_deployer æ— å‚æ•°ï¼‰..."
          set +e  # ä¸´æ—¶å…³é—­é”™è¯¯ä¸­æ–­
          "$LIBRIME_PATH/rime_deployer" 2>&1 | tee load_test.log
          LOAD_EXIT_CODE=$?
          set -e

          # åˆ¤æ–­æ˜¯å¦ä¸ºåŠ¨æ€åº“åŠ è½½å¤±è´¥ï¼ˆå…³é”®ï¼šåŒºåˆ†åŠ¨æ€åº“é”™è¯¯å’Œå‚æ•°é”™è¯¯ï¼‰
          if grep -q "dyld:" load_test.log || grep -q "Library not loaded" load_test.log; then
              echo "âŒ åŠ¨æ€åº“åŠ è½½å¤±è´¥ï¼è¯¦ç»†æ—¥å¿—ï¼š"
              cat load_test.log
              exit 1
          else
              echo "âœ… åŠ¨æ€åº“åŠ è½½æˆåŠŸï¼ˆrime_deployer æ— å‚æ•°è¿”å›å‚æ•°é”™è¯¯ï¼Œå±äºæ­£å¸¸ç°è±¡ï¼‰"
          fi

      - name: Build project (æ ¸å¿ƒæ„å»ºæ­¥éª¤)
        run: |
          LIBRIME_PATH="${{ env.LIBRIME_PATH }}"
          HOMEBREW_PATH="${{ env.HOMEBREW_PATH }}"
          
          # é…ç½®ç¯å¢ƒå˜é‡
          export DYLD_LIBRARY_PATH="$LIBRIME_PATH:$HOMEBREW_PATH/lib:/usr/lib"
          export PATH="$LIBRIME_PATH:$PATH"

          # ç§»åŠ¨ sbxlm ç›®å½•æ–‡ä»¶ï¼ˆæ„å»ºå¿…éœ€ï¼‰
          echo "ğŸ”„ ç§»åŠ¨ sbxlm é…ç½®æ–‡ä»¶..."
          if [[ -d "sbxlm" ]]; then
              mv -f sbxlm/* .
              echo "âœ… sbxlm æ–‡ä»¶ç§»åŠ¨å®Œæˆ"
          else
              echo "âš ï¸ sbxlm ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡ç§»åŠ¨"
          fi

          # åˆ›å»ºæ„å»ºç›®æ ‡ç›®å½•
          RIME_TARGET="$PWD/tmp_rime"
          mkdir -p "$RIME_TARGET"

          # æ‰§è¡Œ Rime æ„å»ºï¼ˆæ ¸å¿ƒå‘½ä»¤ï¼‰
          echo "ğŸ”¨ æ‰§è¡Œ rime_deployer --build..."
          rime_deployer --build . "$RIME_TARGET" 2>&1 | tee build.log
          if [[ $? -ne 0 ]]; then
              echo "âŒ æ„å»ºå¤±è´¥ï¼è¯¦ç»†æ—¥å¿—ï¼š"
              cat build.log
              exit 1
          fi
          echo "âœ… é¡¹ç›®æ„å»ºæˆåŠŸï¼"

      - name: Clean up and package
        run: |
          # æ¸…ç†å†—ä½™æ–‡ä»¶
          rm -rf bihua* zhlf* sbfc* *.extended.dict.yaml *2.schema.yaml user.yaml sbpy.base.dict.yaml sbpy.ext.dict.yaml sbpy.tencent.dict.yaml 2>/dev/null
          
          # æ‰“åŒ…æ„å»ºäº§ç‰©
          zip -q -r sbsrf.zip build lua opencc *.yaml *.txt 2>/dev/null
          if [[ -f "sbsrf.zip" ]]; then
              echo "âœ… æ‰“åŒ…æˆåŠŸï¼æ–‡ä»¶å¤§å°ï¼š$(du -h sbsrf.zip | awk '{print $1}')"
          else
              echo "âš ï¸ æœªç”Ÿæˆ sbsrf.zipï¼ˆæ— åŒ¹é…æ–‡ä»¶ï¼‰"
          fi

      - name: Upload release artifact
        uses: softprops/action-gh-release@v1
        with:
          files: sbsrf.zip
          prerelease: ${{ github.event_name == 'workflow_dispatch' }}
          body: |
            **Build Environment**: macOS-latest (${{ env.HOMEBREW_PATH == '/opt/homebrew' && 'Apple Silicon' || 'Intel' }})
            **Trigger Type**: ${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'Tag Push' }}
            ${{ github.event_name == 'workflow_dispatch' && format('**Reason**: {0}', github.event.inputs.reason) || '' }}
