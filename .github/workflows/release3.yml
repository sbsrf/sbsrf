name: Release (macOS)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'æµ‹è¯•åŸå› ï¼ˆé€‰å¡«ï¼‰'
        required: false
        default: 'Manual test run on macOS'
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build-on-macos:
    runs-on: macos-latest
    defaults:
      run:
        shell: zsh {0}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install missing dependencies (é€‚é… Apple Silicon è·¯å¾„)
        run: |
          # 1. æ£€æµ‹ CPU æ¶æ„ï¼Œç¡®å®š Homebrew è·¯å¾„
          if [[ $(uname -m) == "arm64" ]]; then
              HOMEBREW_PATH="/opt/homebrew"
          else
              HOMEBREW_PATH="/usr/local"
          fi
          echo "ğŸ“‹ æ£€æµ‹åˆ° CPU æ¶æ„ï¼š$(uname -m)ï¼ŒHomebrew è·¯å¾„ï¼š$HOMEBREW_PATH"
          echo "HOMEBREW_PATH=$HOMEBREW_PATH" >> $GITHUB_ENV
          # æå‰è®¾ç½® LIBRIME_PATH åˆ°ç¯å¢ƒå˜é‡ï¼ˆé¿å…åç»­è¡¨è¾¾å¼é—®é¢˜ï¼‰
          LIBRIME_PATH="$PWD/librime"
          echo "LIBRIME_PATH=$LIBRIME_PATH" >> $GITHUB_ENV

          # 2. ç¡®ä¿ Homebrew å¯ç”¨ï¼ˆé€‚é…ä¸åŒæ¶æ„ï¼‰
          if [[ ! -f "$HOMEBREW_PATH/bin/brew" ]]; then
              echo "ğŸ“¦ å®‰è£… Homebrew..."
              /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi

          # 3. å®‰è£…ä¾èµ–åº“ï¼ˆlibiconv å·²åŒ…å«åœ¨ macOS ç³»ç»Ÿä¸­ï¼Œæ— éœ€å•ç‹¬å®‰è£…ï¼‰
          echo "ğŸ“¦ å®‰è£… boost ä¾èµ–..."
          "$HOMEBREW_PATH/bin/brew" install boost

          # 4. ç®€åŒ–éªŒè¯é€»è¾‘ï¼ˆé¿å…é€šé…ç¬¦æŠ¥é”™ï¼‰
          echo "ğŸ“‹ éªŒè¯ä¾èµ–å®‰è£…ï¼š"
          if [[ -d "$HOMEBREW_PATH/lib" ]]; then
              ls -la "$HOMEBREW_PATH/lib/libboost"* 2>/dev/null || echo "âš ï¸ boost åº“æœªæ‰¾åˆ°ï¼ˆå¿½ç•¥ï¼Œç»§ç»­æ‰§è¡Œï¼‰"
          else
              echo "âš ï¸ Homebrew lib ç›®å½•ä¸å­˜åœ¨"
          fi
          # éªŒè¯ç³»ç»Ÿè‡ªå¸¦çš„ libiconv
          ls -la /usr/lib/libiconv* 2>/dev/null || echo "âš ï¸ ç³»ç»Ÿ libiconv æœªæ‰¾åˆ°ï¼ˆå¿½ç•¥ï¼‰"

      - name: Download and extract librime
        run: |
          LIBRIME_URL="https://github.com/rime/librime/releases/download/1.16.1/rime-de4700e-macOS-universal.tar.bz2"
          LIBRIME_ARCHIVE="librime/rime.tar.bz2"
          
          mkdir -p "${{ env.LIBRIME_PATH }}"
          curl -L -o "$LIBRIME_ARCHIVE" "$LIBRIME_URL" || { echo "âŒ ä¸‹è½½ librime å¤±è´¥"; exit 1; }
          
          if [[ ! -f "$LIBRIME_ARCHIVE" ]]; then
              echo "âŒ ä¸‹è½½çš„ librime æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
          fi
          
          tar -xjf "$LIBRIME_ARCHIVE" -C "${{ env.LIBRIME_PATH }}/" --strip-components=2 || { echo "âŒ è§£å‹ librime å¤±è´¥"; exit 1; }
          echo "âœ… å·²è§£å‹ librime åˆ°: ${{ env.LIBRIME_PATH }}"
          # ç¡®è®¤æ ¸å¿ƒæ–‡ä»¶å­˜åœ¨
          if [[ ! -f "${{ env.LIBRIME_PATH }}/librime.1.dylib" ]]; then
              echo "âŒ æœªæ‰¾åˆ° librime.1.dylib åŠ¨æ€åº“"
              exit 1
          fi
          if [[ ! -f "${{ env.LIBRIME_PATH }}/rime_deployer" ]]; then
              echo "âŒ æœªæ‰¾åˆ° rime_deployer å¯æ‰§è¡Œæ–‡ä»¶"
              exit 1
          fi

      - name: Fix rime_deployer dynamic library paths
        run: |
          HOMEBREW_PATH="${{ env.HOMEBREW_PATH }}"
          LIBRIME_PATH="${{ env.LIBRIME_PATH }}"
          RIME_DEPLOYER_PATH="$LIBRIME_PATH/rime_deployer"
          LIBRIME_DYLIB_PATH="$LIBRIME_PATH/librime.1.dylib"
          
          # 1. ä¿®å¤ rime_deployer å¯¹ librime çš„å¼•ç”¨
          echo "ğŸ”§ ä¿®å¤ rime_deployer åŠ¨æ€åº“å¼•ç”¨..."
          install_name_tool -change "@rpath/librime.1.dylib" "$LIBRIME_DYLIB_PATH" "$RIME_DEPLOYER_PATH"
          
          # 2. ä¿®å¤ librime.1.dylib çš„ä¾èµ–ï¼ˆé€‚é…ç³»ç»Ÿ libiconvï¼‰
          if otool -L "$LIBRIME_DYLIB_PATH" | grep -q "libiconv"; then
              echo "ğŸ”§ ä¿®å¤ librime.1.dylib çš„ libiconv å¼•ç”¨..."
              # ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ libiconvï¼ˆæ— éœ€ Homebrew ç‰ˆæœ¬ï¼‰
              SYSTEM_ICONV_PATH="/usr/lib/libiconv.2.dylib"
              install_name_tool -change "@rpath/libiconv.2.dylib" "$SYSTEM_ICONV_PATH" "$LIBRIME_DYLIB_PATH"
          fi
          
          # 3. ä¿®å¤ boost ä¾èµ–ï¼ˆå¦‚æœæœ‰ï¼‰
          if otool -L "$LIBRIME_DYLIB_PATH" | grep -q "boost"; then
              echo "ğŸ”§ ä¿®å¤ librime.1.dylib çš„ boost å¼•ç”¨..."
              BOOST_PATH="$HOMEBREW_PATH/lib/libboost_regex-mt.dylib"
              install_name_tool -change "@rpath/libboost_regex-mt.dylib" "$BOOST_PATH" "$LIBRIME_DYLIB_PATH"
          fi

      - name: Test dynamic library loading
        run: |
          HOMEBREW_PATH="${{ env.HOMEBREW_PATH }}"
          LIBRIME_PATH="${{ env.LIBRIME_PATH }}"
          RIME_DEPLOYER_PATH="$LIBRIME_PATH/rime_deployer"
          
          # é…ç½®å®Œæ•´çš„åŠ¨æ€åº“è·¯å¾„ï¼ˆé€‚é… Apple Siliconï¼‰
          export DYLD_LIBRARY_PATH="$LIBRIME_PATH:$HOMEBREW_PATH/lib:/usr/lib:$DYLD_LIBRARY_PATH"
          export PATH="$LIBRIME_PATH:$PATH"
          
          # è¯¦ç»†è°ƒè¯•åŠ¨æ€åº“åŠ è½½
          echo "ğŸ“‹ åŠ¨æ€åº“æœç´¢è·¯å¾„ï¼š$DYLD_LIBRARY_PATH"
          echo "ğŸ“‹ æµ‹è¯• rime_deployer åŠ è½½..."
          if DYLD_PRINT_LIBRARIES=1 "$RIME_DEPLOYER_PATH" -h >/dev/null 2>&1; then
              echo "âœ… åŠ¨æ€åº“åŠ è½½æµ‹è¯•é€šè¿‡"
          else
              echo "âŒ åŠ¨æ€åº“åŠ è½½æµ‹è¯•å¤±è´¥ï¼Œè¯¦ç»†æ—¥å¿—ï¼š"
              DYLD_PRINT_ERRORS=1 "$RIME_DEPLOYER_PATH" -h 2>&1
              exit 1
          fi

      - name: Build project
        run: |
          HOMEBREW_PATH="${{ env.HOMEBREW_PATH }}"
          LIBRIME_PATH="${{ env.LIBRIME_PATH }}"  # ç›´æ¥ä½¿ç”¨å·²é…ç½®çš„ç¯å¢ƒå˜é‡ï¼Œæ— éœ€è¡¨è¾¾å¼åˆ¤æ–­
          # é…ç½®ç¯å¢ƒå˜é‡
          export PATH="$LIBRIME_PATH:$PATH"
          export DYLD_LIBRARY_PATH="$LIBRIME_PATH:$HOMEBREW_PATH/lib:/usr/lib:$DYLD_LIBRARY_PATH"
          
          # ç§»åŠ¨ sbxlm æ–‡ä»¶
          echo "ğŸ”„ ç§»åŠ¨ sbxlm ç›®å½•ä¸‹çš„æ–‡ä»¶..."
          setopt null_glob
          mv -f sbxlm/* . 2>/dev/null || echo "âš ï¸ sbxlm ç›®å½•å¯èƒ½ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          unsetopt null_glob
          
          # æ‰§è¡Œæ„å»º
          RIME_TEMP_DIR="$PWD/tmp_rime"
          mkdir -p "$RIME_TEMP_DIR"
          echo "ğŸ”¨ è¿è¡Œ rime_deployer --build..."
          rime_deployer --build -v . "$RIME_TEMP_DIR" 2>&1 | tee build_error.log
          if [[ $? -ne 0 ]]; then
              echo "âŒ æ„å»ºå¤±è´¥ï¼è¯¦ç»†æ—¥å¿—ï¼š"
              cat build_error.log
              exit 1
          fi
          echo "âœ… æ„å»ºæˆåŠŸï¼"

      - name: Clean up and package
        run: |
          # æ¸…ç†æ–‡ä»¶
          rm -rf bihua* zhlf* sbfc* *.extended.dict.yaml *2.schema.yaml user.yaml sbpy.base.dict.yaml sbpy.ext.dict.yaml sbpy.tencent.dict.yaml 2>/dev/null
          # æ‰“åŒ…
          zip -q -r sbsrf.zip build lua opencc *.yaml *.txt 2>/dev/null
          if [[ -f "sbsrf.zip" ]]; then
              echo "âœ… æ‰“åŒ…æˆåŠŸï¼æ–‡ä»¶ä½ç½®ï¼š$PWD/sbsrf.zip"
              du -h sbsrf.zip
          else
              echo "âš ï¸  æ‰“åŒ…æ­¥éª¤æœªæ‰¾åˆ°æŒ‡å®šæ–‡ä»¶ï¼Œæœªç”Ÿæˆ sbsrf.zip"
          fi

      - name: Upload release artifact
        uses: softprops/action-gh-release@v1
        with:
          files: sbsrf.zip
          prerelease: ${{ github.event_name == 'workflow_dispatch' }}
          body: |
            **Build Environment**: macOS-latest (${{ env.HOMEBREW_PATH == '/opt/homebrew' && 'Apple Silicon' || 'Intel' }})
            **Trigger Type**: ${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'Tag Push' }}
            ${{ github.event_name == 'workflow_dispatch' && format('**Reason**: {0}', github.event.inputs.reason) || '' }}
